<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#dc2626">
    <title>SOS Emergency - Ocean Hazard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body {
            background-color: #fef2f2;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .sos-header {
            background-color: #dc2626;
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .sos-container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        h3 {
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
            margin-top: 25px;
        }

        .emergency-type-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .emergency-option {
            background: white;
            border: 2px solid #fee2e2;
            border-radius: 12px;
            padding: 20px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .emergency-option:hover {
            border-color: #dc2626;
            background: #fef2f2;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.1);
        }

        .emergency-option input {
            display: none;
        }

        .emergency-option.selected {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(220, 38, 38, 0.3);
        }

        .emergency-icon {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 10px;
        }

        .emergency-label {
            font-weight: 700;
            font-size: 0.9rem;
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .btn-sos-submit {
            background: #dc2626;
            color: white;
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 800;
            border: none;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-sos-submit:active {
            transform: scale(0.98);
        }

        .btn-sos-submit:disabled {
            background: #feaaaa;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin-top: 20px;
            color: #6b7280;
            text-decoration: none;
            font-weight: 500;
            padding: 10px;
        }

        .back-link:hover {
            color: #dc2626;
        }

        /* Loading Animation Override */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <header class="sos-header">
        <h1 style="margin: 0; font-size: 2rem;">üÜò SOS</h1>
        <p style="margin: 5px 0 0; opacity: 0.9;" data-i18n="emergency_reporting">Emergency Reporting</p>
    </header>

    <div class="sos-container">
        <div id="location-status"
            style="text-align: center; margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; gap: 10px;">
            <span class="location-icon" style="font-size: 1.5rem;">üìç</span>
            <div>
                <span id="location-text" style="font-weight: 600; color: #4b5563;">Locating you...</span>
                <div id="location-accuracy" style="font-size: 0.8rem; color: #9ca3af;">Checking GPS signal</div>
            </div>
        </div>

        <form id="sos-form">
            <h3 data-i18n="emergency_type">Nature of Emergency</h3>
            <div class="emergency-type-grid">
                <label class="emergency-option">
                    <input type="radio" name="emergency_type" value="drowning" required>
                    <span class="emergency-icon">üèä</span>
                    <span class="emergency-label" data-i18n="drowning">Drowning</span>
                </label>
                <label class="emergency-option">
                    <input type="radio" name="emergency_type" value="boat_accident" required>
                    <span class="emergency-icon">üö§</span>
                    <span class="emergency-label" data-i18n="boat_accident">Boat Accident</span>
                </label>
                <label class="emergency-option">
                    <input type="radio" name="emergency_type" value="stranded" required>
                    <span class="emergency-icon">üèùÔ∏è</span>
                    <span class="emergency-label" data-i18n="stranded">Stranded</span>
                </label>
                <label class="emergency-option">
                    <input type="radio" name="emergency_type" value="medical" required>
                    <span class="emergency-icon">üè•</span>
                    <span class="emergency-label" data-i18n="medical">Medical</span>
                </label>
            </div>

            <div class="form-group">
                <label class="form-label" data-i18n="contact_number">Contact Number (Important)</label>
                <input type="tel" name="contact_number" class="form-input" placeholder="e.g., 9945XXXXXX" required
                    pattern="[0-9]{10}" title="Please enter a valid 10-digit mobile number">
            </div>

            <div class="form-group">
                <label class="form-label" data-i18n="description">Details (Optional)</label>
                <textarea name="description" class="form-textarea" rows="3"
                    placeholder="Number of people, specific situation..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label" data-i18n="image_label">Photo (Optional)</label>
                <input type="file" id="image-input" name="image" accept="image/*" capture="environment"
                    class="form-input" style="padding: 10px; background: white;">
            </div>

            <!-- Hidden Fields for Location -->
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">
            <input type="hidden" id="location_name" name="location_name">

            <button type="submit" id="sos-submit-btn" class="btn-sos-submit" disabled>
                <span id="btn-text">üö® <span data-i18n="send_sos">SEND SOS ALERT</span></span>
            </button>
        </form>

        <a href="/" class="back-link">
            ‚Üê <span data-i18n="back_to_home">Back to Home</span>
        </a>
    </div>

    <!-- Scripts -->
    <script src="/js/config.js"></script>
    <script src="/js/translation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Initialize Translations
            if (window.TranslationManager) {
                await TranslationManager.init();
            }

            // 2. Highlight Selection Logic
            const options = document.querySelectorAll('input[name="emergency_type"]');
            options.forEach(input => {
                input.addEventListener('change', (e) => {
                    document.querySelectorAll('.emergency-option').forEach(el => el.classList.remove('selected'));
                    e.target.closest('.emergency-option').classList.add('selected');
                    checkValidity();
                });
            });

            // 3. Location Service (Robust)
            const statusText = document.getElementById('location-text');
            const accuracyText = document.getElementById('location-accuracy');

            function updateLocationUI(lat, lng, accuracy, source = "GPS") {
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lng;
                statusText.textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
                statusText.style.color = '#059669'; // Green
                accuracyText.textContent = `Source: ${source} (¬±${Math.round(accuracy)}m)`;
                checkValidity();
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    // Success
                    (pos) => {
                        const { latitude, longitude, accuracy } = pos.coords;
                        updateLocationUI(latitude, longitude, accuracy);

                        // Optional: Reverse Geocoding
                        fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`)
                            .then(res => res.json())
                            .then(data => {
                                const locality = data.locality || data.city || data.principalSubdivision;
                                if (locality) {
                                    document.getElementById('location_name').value = locality;
                                    statusText.textContent = `üìç ${locality}`;
                                }
                            })
                            .catch(err => console.log('Geocoding failed, using coords'));
                    },
                    // Error
                    (err) => {
                        console.error('GPS Error:', err);
                        statusText.textContent = "‚ö†Ô∏è GPS Unavailable";
                        statusText.style.color = '#dc2626';
                        accuracyText.textContent = "Falling back to Estimated Location";

                        // Fallback (e.g. Center of region or IP based - here we mock for UX flow if needed, but best to enforce GPS for SOS)
                        // For SAFETY: We usually don't want to fake SOS location.
                        // But for usability if GPS is just flaky:
                        alert("Please enable GPS for accurate rescue!");
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                statusText.textContent = "Geolocation not supported";
            }

            // 4. Form Validation
            const form = document.getElementById('sos-form');
            const contactInput = document.querySelector('input[name="contact_number"]');

            form.addEventListener('input', checkValidity);

            function checkValidity() {
                const type = document.querySelector('input[name="emergency_type"]:checked');
                const contact = contactInput.value;
                const lat = document.getElementById('latitude').value;
                const btn = document.getElementById('sos-submit-btn');

                // Basic validation: Type selected, contact has valid length (at least 10), location found
                if (type && contact.length >= 10 && lat) {
                    btn.disabled = false;
                } else {
                    btn.disabled = true;
                }
            }

            // 5. Submit Handler
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('sos-submit-btn');
                const originalContent = btn.innerHTML;

                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> Sending...';

                try {
                    const formData = new FormData(form);

                    // Verify API Config
                    const baseUrl = (window.API_CONFIG && window.API_CONFIG.BASE_URL) ? window.API_CONFIG.BASE_URL : '/api';

                    const response = await fetch(`${baseUrl}/sos/reports`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        btn.innerHTML = '‚úÖ ALERT SENT';
                        btn.style.background = '#059669'; // Green

                        // Show success message then redirect
                        setTimeout(() => {
                            alert('‚ö†Ô∏è SOS ALERT BROADCASTED!\n\nRescue teams have been notified of your location.\nStay calm and wait for help.');
                            window.location.href = '/';
                        }, 500);
                    } else {
                        throw new Error('Server returned ' + response.status);
                    }
                } catch (error) {
                    console.error('SOS submit failed:', error);
                    alert('‚ùå FAILED TO SEND ALERT!\n\nPlease check your internet connection or CALL EMERGENCY SERVICES (102/108) IMMEDIATELY.');
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            });
        });
    </script>
</body>

</html>